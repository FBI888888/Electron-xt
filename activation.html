<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½¯ä»¶æ¿€æ´»</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .activation-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 480px;
            padding: 50px 40px;
            text-align: center;
        }
        
        .logo {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 14px;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            color: #555;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .form-group input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            font-family: 'Consolas', 'Monaco', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-group input::placeholder {
            text-transform: none;
            letter-spacing: 0;
            color: #bbb;
        }
        
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 12px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .message {
            padding: 14px 18px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        
        .message.error {
            background: #fee2e2;
            color: #dc2626;
            display: block;
        }
        
        .message.success {
            background: #d1fae5;
            color: #059669;
            display: block;
        }
        
        .status-info {
            background: #f0fdf4;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: left;
            display: none;
        }
        
        .status-info.show {
            display: block;
        }
        
        .status-info h3 {
            color: #059669;
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-item .label {
            color: #666;
        }
        
        .status-item .value {
            color: #333;
            font-weight: 600;
        }
        
        .status-item .value.vip {
            color: #f59e0b;
        }
        
        .status-item .value.vvip {
            color: #7c3aed;
        }
        
        .status-item .value.svip {
            color: #db2777;
        }
        
        .footer {
            margin-top: 30px;
            color: #999;
            font-size: 12px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="activation-container">
        <div class="logo">ğŸ”</div>
        <h1>æ˜Ÿå›¾è¾¾äººé‡‡é›†ç®¡ç†ç³»ç»Ÿ</h1>
        <p class="version" style="color: #888; font-size: 12px; margin: -5px 0 10px;">V1.1.0</p>
        <p class="subtitle">è¯·è¾“å…¥æ¿€æ´»ç ä»¥è§£é”è½¯ä»¶åŠŸèƒ½</p>
        
        
        <!-- çŠ¶æ€ä¿¡æ¯ (å·²æ¿€æ´»æ—¶æ˜¾ç¤º) -->
        <div class="status-info" id="statusInfo">
            <h3>âœ… è½¯ä»¶å·²æ¿€æ´»</h3>
            <div class="status-item">
                <span class="label">æ¿€æ´»ç </span>
                <span class="value" id="infoKey">-</span>
            </div>
            <div class="status-item">
                <span class="label">ä¼šå‘˜ç­‰çº§</span>
                <span class="value" id="infoLevel">-</span>
            </div>
            <div class="status-item">
                <span class="label">åˆ°æœŸæ—¶é—´</span>
                <span class="value" id="infoExpire">-</span>
            </div>
            <div class="status-item">
                <span class="label">å‰©ä½™å¤©æ•°</span>
                <span class="value" id="infoDays">-</span>
            </div>
        </div>
        
        <!-- æ¶ˆæ¯æç¤º -->
        <div class="message" id="message"></div>
        
        <!-- æ¿€æ´»è¡¨å• -->
        <div id="activationForm">
            <div class="form-group">
                <label>æ¿€æ´»ç </label>
                <input type="text" id="licenseKey" placeholder="è¯·è¾“å…¥æ¿€æ´»ç  (å¦‚: XXXX-XXXX-XXXX-XXXX)" maxlength="20">
            </div>
            
            <button class="btn btn-primary" id="activateBtn" onclick="doActivate()">
                ç«‹å³æ¿€æ´»
            </button>
        </div>
        
        <!-- å·²æ¿€æ´»æ—¶çš„æŒ‰é’® -->
        <div id="activatedActions" style="display: none;">
            <button class="btn btn-primary" onclick="enterApp()">
                è¿›å…¥è½¯ä»¶
            </button>
        </div>
        
        <div class="footer">
            å¦‚éœ€è´­ä¹°æ¿€æ´»ç ï¼Œè¯·è”ç³»å®¢æœ
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        
        let currentLicenseInfo = null;
        
        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', async () => {
            // æ£€æŸ¥æ¿€æ´»çŠ¶æ€
            checkActivation();
            
            // å›è½¦é”®æ¿€æ´»
            document.getElementById('licenseKey').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    doActivate();
                }
            });
        });
        
        // æ£€æŸ¥æ¿€æ´»çŠ¶æ€ (å‘æœåŠ¡å™¨éªŒè¯)
        async function checkActivation() {
            // ä½¿ç”¨ verify-license å‘æœåŠ¡å™¨éªŒè¯ï¼Œè€Œä¸æ˜¯åªæ£€æŸ¥æœ¬åœ°ç¼“å­˜
            const result = await ipcRenderer.invoke('verify-license');
            
            if (result.success) {
                // æœåŠ¡å™¨éªŒè¯é€šè¿‡ï¼Œæ˜¾ç¤ºæ¿€æ´»ä¿¡æ¯
                currentLicenseInfo = result.data;
                showActivatedStatus(result.data);
            } else {
                // æœåŠ¡å™¨éªŒè¯å¤±è´¥ (å¯èƒ½è¢«è§£ç»‘/ç¦ç”¨)ï¼Œæ˜¾ç¤ºæ¿€æ´»è¡¨å•
                showActivationForm();
                if (result.message && result.code !== 'NOT_ACTIVATED') {
                    showMessage(result.message, 'error');
                }
            }
        }
        
        // æ˜¾ç¤ºæ¿€æ´»è¡¨å•
        function showActivationForm() {
            document.getElementById('statusInfo').classList.remove('show');
            document.getElementById('activationForm').style.display = 'block';
            document.getElementById('activatedActions').style.display = 'none';
        }
        
        // æ˜¾ç¤ºå·²æ¿€æ´»çŠ¶æ€
        function showActivatedStatus(info) {
            document.getElementById('statusInfo').classList.add('show');
            document.getElementById('activationForm').style.display = 'none';
            document.getElementById('activatedActions').style.display = 'block';
            
            document.getElementById('infoKey').textContent = info.license_key;
            
            const levelEl = document.getElementById('infoLevel');
            levelEl.textContent = info.member_level;
            levelEl.className = 'value ' + info.member_level.toLowerCase();
            
            document.getElementById('infoExpire').textContent = 
                new Date(info.expire_at).toLocaleString('zh-CN');
            document.getElementById('infoDays').textContent = info.days_remaining + ' å¤©';
        }
        
        // æ¿€æ´»
        async function doActivate() {
            const licenseKey = document.getElementById('licenseKey').value.trim();
            
            if (!licenseKey) {
                showMessage('è¯·è¾“å…¥æ¿€æ´»ç ', 'error');
                return;
            }
            
            const btn = document.getElementById('activateBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>æ¿€æ´»ä¸­...';
            
            try {
                const result = await ipcRenderer.invoke('activate-license', licenseKey);
                
                if (result.success) {
                    showMessage('æ¿€æ´»æˆåŠŸï¼', 'success');
                    setTimeout(() => {
                        checkActivation();
                    }, 1000);
                } else if (result.code === 'ALREADY_ACTIVATED') {
                    // æˆæƒç å·²è¢«å…¶ä»–è®¾å¤‡ä½¿ç”¨ï¼Œè¯¢é—®æ˜¯å¦è§£ç»‘
                    btn.disabled = false;
                    btn.innerHTML = 'ç«‹å³æ¿€æ´»';
                    showConfirmUnbind(licenseKey);
                } else {
                    showMessage(result.message || 'æ¿€æ´»å¤±è´¥', 'error');
                }
            } catch (e) {
                showMessage('æ¿€æ´»è¯·æ±‚å¤±è´¥: ' + e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ç«‹å³æ¿€æ´»';
            }
        }
        
        // æ˜¾ç¤ºè§£ç»‘ç¡®è®¤å¯¹è¯æ¡†
        async function showConfirmUnbind(licenseKey) {
            const confirmed = await ipcRenderer.invoke('show-confirm-dialog', {
                title: 'æˆæƒç å·²è¢«ä½¿ç”¨',
                message: 'è¯¥æˆæƒç å·²ç»‘å®šåˆ°å…¶ä»–è®¾å¤‡ã€‚\n\nç»§ç»­æ¿€æ´»å°†è§£ç»‘åŸè®¾å¤‡ï¼Œå¹¶ç»‘å®šåˆ°å½“å‰è®¾å¤‡ã€‚\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ',
                buttons: ['å–æ¶ˆ', 'ç¡®å®šè§£ç»‘å¹¶æ¿€æ´»']
            });
            
            if (confirmed) {
                // ç”¨æˆ·ç¡®è®¤ï¼Œå¼ºåˆ¶æ¿€æ´»ï¼ˆè§£ç»‘åŸè®¾å¤‡ï¼‰
                const btn = document.getElementById('activateBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span>è§£ç»‘ä¸­...';
                
                try {
                    const result = await ipcRenderer.invoke('activate-license', licenseKey, true); // force=true
                    
                    if (result.success) {
                        showMessage('æ¿€æ´»æˆåŠŸï¼åŸè®¾å¤‡å·²è§£ç»‘', 'success');
                        setTimeout(() => {
                            checkActivation();
                        }, 1000);
                    } else {
                        showMessage(result.message || 'æ¿€æ´»å¤±è´¥', 'error');
                    }
                } catch (e) {
                    showMessage('æ¿€æ´»è¯·æ±‚å¤±è´¥: ' + e.message, 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = 'ç«‹å³æ¿€æ´»';
                }
            }
        }
        
        // è¿›å…¥åº”ç”¨
        function enterApp() {
            ipcRenderer.invoke('enter-main-app');
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = 'message ' + type;
        }
        
        // éšè—æ¶ˆæ¯
        function hideMessage() {
            document.getElementById('message').className = 'message';
        }
    </script>
</body>
</html>
